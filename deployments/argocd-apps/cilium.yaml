apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: cilium
  namespace: argocd
spec:
  project: default

  source:

  sources:
  - repoURL: https://helm.cilium.io/
    targetRevision: 1.18.0

    # helm specific config
    chart: cilium
    helm:
      #passCredentials: false # If true then adds --pass-credentials to Helm commands to pass credentials to all domains
      ## Extra parameters to set (same as setting through values.yaml, but these take precedence)
      parameters:
      - name: "ipam.mode"
        value: "kubernetes"
      - name: "kubeProxyReplacement"
        value: "true"
      - name: "securityContext.capabilities.ciliumAgent"
        value: "{CHOWN,KILL,NET_ADMIN,NET_RAW,IPC_LOCK,SYS_ADMIN,SYS_RESOURCE,DAC_OVERRIDE,FOWNER,SETGID,SETUID}"
      - name: "securityContext.capabilities.cleanCiliumState"
        value: "{NET_ADMIN,SYS_ADMIN,SYS_RESOURCE}"
      - name: "cgroup.autoMount.enabled"
        value: "false"
      - name: "cgroup.hostRoot"
        value: "/sys/fs/cgroup"
      - name: "k8sServiceHost"
        value: "localhost"
      - name: "k8sServicePort"
        value: "7445"
      - name: "operator.replicas"
        value: "1"
      #- name: "nginx-ingress.controller.service.annotations.external-dns\\.alpha\\.kubernetes\\.io/hostname"
      #  value: mydomain.example.com
      #- name: "ingress.annotations.kubernetes\\.io/tls-acme"
      #  value: "true"
      #  forceString: true # ensures that value is treated as a string

      ## Use the contents of files as parameters (uses Helm's --set-file)
      #fileParameters:
      #- name: config
      #  path: files/config.json

      ## Helm values files for overriding values in the helm chart
      ## The path is relative to the spec.source.path directory defined above
      #valueFiles:
      #- values-prod.yaml

      # Ignore locally missing valueFiles when installing Helm chart. Defaults to false
      ignoreMissingValueFiles: false
  - path: 'deployments/cilium'
    repoURL: 'https://github.com/a-lohmann/terraform-talos-demo.git'
    targetRevision: 'main'

  destination:
    server: https://kubernetes.default.svc
    namespace: kube-system

  syncPolicy:
    syncOptions:
    - CreateNamespace=false
    automated:
      selfHeal: true
      prune: true
